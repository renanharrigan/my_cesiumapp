<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CesiumJS OpenSky Network</title>
    <!-- Tailwind CSS CDN for basic styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CesiumJS CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        /* Custom CSS for the Cesium viewer container */
        #cesiumContainer {
            width: 100%;
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        body {
            font-family: 'Inter', sans-serif; /* Use Inter font */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars */
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="loadingOverlay" class="loading-overlay">
        Loading CesiumJS and data...
    </div>
    <div id="cesiumContainer"></div>

    <!-- CesiumJS JavaScript -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>

    <script type="module">
        // Ensure all resources are loaded before initializing CesiumJS
        window.onload = function() {
            // Ensure Cesium is loaded before proceeding
            if (typeof Cesium === 'undefined') {
                console.error('CesiumJS is not loaded.');
                document.getElementById('loadingOverlay').textContent = 'Error: CesiumJS failed to load.';
                document.getElementById('loadingOverlay').classList.add('bg-red-700');
                return; // Exit if Cesium is not available
            }

            // Set your Cesium ion default access token
            Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmODM3ODY4YS0xMzE1LTRiMzktYjNhZi1lODdhNTgzY2RkZGYiLCJpZCI6MzIxMTg0LCJpYXQiOjE3NTI0NjQ0OTZ9.n2l0ALm9yy48XpkzjNxYgSw02XXw-PqQ9837LyaJ9Gc';

            // Initialize the Cesium Viewer
            const viewer = new Cesium.Viewer('cesiumContainer', {
                // Disable the base layer picker for a cleaner look if not needed
                baseLayerPicker: false,
                // Disable the geocoder (search bar)
                geocoder: false,
                // Disable the home button
                homeButton: false,
                // Disable the info box
                infoBox: false,
                // Disable the navigation help button
                navigationHelpButton: false,
                // Disable the timeline
                timeline: false,
                // Disable the animation widget
                animation: false,
                // Disable the fullscreen button
                fullscreenButton: false,
                // Disable the scene mode picker
                sceneModePicker: false,
                // Enable lighting for better 3D asset visualization
                scene3DOnly: true,
                shouldAnimate: true,
                // --- NEW: Disable default imagery and terrain to focus on the 3D asset ---
                baseLayer: false, // Prevents loading default imagery
                terrainProvider: new Cesium.EllipsoidTerrainProvider(), // Provides a smooth, untextured globe
            });

            // Add the 3D Tileset from Cesium ion
            const assetId = 3548235;
            let tileset;
            try {
                tileset = viewer.scene.primitives.add(
                    new Cesium.Cesium3DTileset({
                        url: Cesium.IonResource.fromAssetId(assetId),
                    })
                );
            } catch (e) {
                console.error(`Error creating Cesium3DTileset or adding to primitives: ${e}`);
                document.getElementById('loadingOverlay').textContent = `Error initializing 3D asset: ${e.message}`;
                document.getElementById('loadingOverlay').classList.add('bg-red-700');
                return; // Stop execution if tileset creation fails
            }

            // Fly to the tileset once it's loaded, ensuring tileset and its readyPromise are defined
            if (tileset && tileset.readyPromise) {
                tileset.readyPromise.then(function(tileset) {
                    // Zoom to the tileset with a closer view
                    viewer.zoomTo(tileset, new Cesium.HeadingPitchRange(0.0, -0.5, tileset.boundingSphere.radius * 2.0));
                    document.getElementById('loadingOverlay').style.display = 'none'; // Hide loading overlay
                }).otherwise(function(error) {
                    console.error(`Error loading tileset: ${error}`);
                    document.getElementById('loadingOverlay').textContent = `Error loading 3D asset: ${error.message}`;
                    document.getElementById('loadingOverlay').classList.add('bg-red-700');
                });
            } else {
                console.error('Tileset or tileset.readyPromise is undefined after creation.');
                document.getElementById('loadingOverlay').textContent = 'Error: 3D asset failed to initialize properly.';
                document.getElementById('loadingOverlay').classList.add('bg-red-700');
            }

            // Store aircraft entities
            const aircraftEntities = new Map(); // Map from ICAO24 to Cesium Entity

            // Function to fetch and update aircraft data
            async function updateAircraftData() {
                const openskyApiUrl = 'https://opensky-network.org/api/states/all';

                try {
                    const response = await fetch(openskyApiUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data && data.states) {
                        // Filter out aircraft without position data
                        const activeAircraft = data.states.filter(state =>
                            state[5] !== null && state[6] !== null && state[7] !== null // longitude, latitude, altitude
                        );

                        // Create a set of current ICAO24s to detect removed aircraft
                        const currentIcao24s = new Set();

                        activeAircraft.forEach(state => {
                            const icao24 = state[0]; // ICAO24 address
                            const longitude = state[5]; // Longitude
                            const latitude = state[6];  // Latitude
                            const altitude = state[7];  // Barometric altitude in meters (can be null)
                            const callsign = state[1];  // Callsign
                            const velocity = state[9];  // Velocity in m/s
                            const heading = state[10];  // True track in degrees (0-359)

                            currentIcao24s.add(icao24);

                            let position;
                            if (altitude !== null) {
                                // Use altitude if available
                                position = Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude);
                            } else {
                                // If altitude is null, place at ground level
                                position = Cesium.Cartesian3.fromDegrees(longitude, latitude, 0);
                            }

                            if (!aircraftEntities.has(icao24)) {
                                // Create a new entity if it doesn't exist
                                const newEntity = viewer.entities.add({
                                    id: icao24,
                                    position: position,
                                    point: {
                                        pixelSize: 8,
                                        color: Cesium.Color.RED,
                                        outlineColor: Cesium.Color.WHITE,
                                        outlineWidth: 2,
                                    },
                                    label: {
                                        text: callsign ? callsign : icao24,
                                        font: '14px sans-serif',
                                        fillColor: Cesium.Color.WHITE,
                                        outlineColor: Cesium.Color.BLACK,
                                        outlineWidth: 2,
                                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                        pixelOffset: new Cesium.Cartesian2(0, -15),
                                        showBackground: true,
                                        backgroundColor: new Cesium.Color(0.1, 0.1, 0.1, 0.7),
                                        disableDepthTestDistance: Number.POSITIVE_INFINITY // Always show label
                                    },
                                    orientation: heading !== null ? Cesium.Transforms.headingPitchRollQuaternion(
                                        position,
                                        Cesium.HeadingPitchRoll.fromDegrees(heading, 0, 0)
                                    ) : undefined,
                                });
                                aircraftEntities.set(icao24, newEntity);
                            } else {
                                // Update existing entity's position and label
                                const entity = aircraftEntities.get(icao24);
                                entity.position = new Cesium.ConstantPositionProperty(position);
                                if (entity.label) {
                                    entity.label.text = callsign ? callsign : icao24;
                                }
                                if (heading !== null) {
                                    entity.orientation = new Cesium.ConstantProperty(
                                        Cesium.Transforms.headingPitchRollQuaternion(
                                            position,
                                            Cesium.HeadingPitchRoll.fromDegrees(heading, 0, 0)
                                        )
                                    );
                                }
                            }
                        });

                        // Remove aircraft that are no longer in the data
                        aircraftEntities.forEach((entity, icao24) => {
                            if (!currentIcao24s.has(icao24)) {
                                viewer.entities.remove(entity);
                                aircraftEntities.delete(icao24);
                            }
                        });

                    }
                } catch (error) {
                    console.error('Error fetching OpenSky data:', error);
                    // Display a message to the user if there's an API error
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'absolute top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white p-3 rounded-lg shadow-lg z-50';
                    errorMessageDiv.textContent = `Error fetching aircraft data: ${error.message}. Retrying in 10 seconds.`;
                    document.body.appendChild(errorMessageDiv);

                    // Remove message after a few seconds
                    setTimeout(() => errorMessageDiv.remove(), 5000);
                }
            }

            // Initial data fetch
            updateAircraftData();

            // Update aircraft data every 10 seconds
            setInterval(updateAircraftData, 10000); // OpenSky API updates every 10 seconds

            // Handle window resize for responsive canvas
            window.addEventListener('resize', () => {
                viewer.resize();
            });

            // Initial resize call to ensure correct sizing on load
            viewer.resize();
        }; // End of window.onload
    </script>
</body>
</html>
