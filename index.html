<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CesiumJS OpenSky Aircraft Tracker</title>
    <!-- Include CesiumJS CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif; /* Using Inter font */
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        #cesiumContainer {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            z-index: 10;
            border-radius: 8px;
        }
        #infoPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 0.9em;
            z-index: 5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }
        #infoPanel h3 {
            margin-top: 0;
            color: #4CAF50;
            font-size: 1.2em;
        }
        #infoPanel p {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="loadingOverlay">Loading CesiumJS and aircraft data...</div>
    <div id="infoPanel">
        <h3>OpenSky Aircraft Tracker</h3>
        <p>Aircraft Visible: <span id="aircraftCount">0</span></p>
        <p>Last Updated: <span id="lastUpdated">N/A</span></p>
        <p>Data Source: OpenSky Network API</p>
        <p>Cesium Ion Asset ID: 3548639</p>
    </div>

    <!-- Include CesiumJS JavaScript -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>

    <script>
        // Set your Cesium Ion default access token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmODM3ODY4YS0xMzE1LTRiMzktYjNhZi1lODdhNTgzY2RkZGYiLCJpZCI6MzIxMTg0LCJpYXQiOjE3NTI0NjQ0OTZ9.n2l0ALm9yy48XpkzjNxYgSw02XXw-PqQ9837LyaJ9Gc';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            // Disable default terrain and imagery for a cleaner view if desired, or keep them.
            // terrainProvider: Cesium.createWorldTerrain(),
            // imageryProvider: new Cesium.ArcGisMapServerImageryProvider({
            //     url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
            // }),
            animation: false, // Disable the animation widget
            timeline: false,  // Disable the timeline widget
            geocoder: false,  // Disable the geocoder widget
            homeButton: false, // Disable the home button
            navigationHelpButton: false, // Disable the navigation help button
            baseLayerPicker: false, // Disable the base layer picker
            fullscreenButton: false, // Disable the fullscreen button
            sceneModePicker: false, // Disable the scene mode picker
        });

        // Store aircraft entities to update them
        const aircraftEntities = new Map();
        const OPEN_SKY_API_URL = 'https://opensky-network.org/api/states/all';
        const ASSET_ID = 3548639; // Your Cesium ion 3D Asset ID

        const loadingOverlay = document.getElementById('loadingOverlay');
        const aircraftCountSpan = document.getElementById('aircraftCount');
        const lastUpdatedSpan = document.getElementById('lastUpdated');

        /**
         * Loads a 3D asset from Cesium Ion.
         */
        async function loadCesiumIonAsset() {
            try {
                const tileset = await Cesium.IonResource.fromAssetId(ASSET_ID);
                viewer.scene.primitives.add(tileset);
                // Optionally, zoom to the tileset
                viewer.zoomTo(tileset);
                console.log(`Successfully loaded Cesium Ion Asset ID: ${ASSET_ID}`);
            } catch (error) {
                console.error(`Error loading Cesium Ion Asset ID ${ASSET_ID}:`, error);
                // Display an error message to the user if asset loading fails
                loadingOverlay.innerHTML = `Error loading 3D asset: ${error.message}. Please check console for details.`;
            }
        }

        /**
         * Fetches aircraft data from the OpenSky Network API and updates Cesium entities.
         */
        async function fetchAircraftData() {
            loadingOverlay.style.display = 'flex'; // Show loading overlay
            try {
                const response = await fetch(OPEN_SKY_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data && data.states) {
                    let currentAircraftCount = 0;
                    const updatedAircraftIcaos = new Set();

                    data.states.forEach(state => {
                        const icao24 = state[0]; // ICAO24 address
                        const callsign = state[1] ? state[1].trim() : 'N/A'; // Callsign
                        const longitude = state[5]; // Longitude
                        const latitude = state[6];  // Latitude
                        const baro_altitude = state[7]; // Barometric altitude in meters
                        const on_ground = state[8]; // On ground status
                        const velocity = state[9]; // Velocity in m/s
                        const true_track = state[10]; // True track in degrees (heading)

                        // Only display airborne aircraft with valid coordinates and altitude
                        if (longitude !== null && latitude !== null && baro_altitude !== null && !on_ground) {
                            const position = Cesium.Cartesian3.fromDegrees(longitude, latitude, baro_altitude);

                            let entity = aircraftEntities.get(icao24);

                            if (entity) {
                                // Update existing entity position and orientation
                                entity.position = new Cesium.ConstantPositionProperty(position);
                                if (true_track !== null) {
                                    // Convert heading from degrees (0-360, North is 0) to Cesium heading (radians, East is 0)
                                    // Cesium.HeadingPitchRoll.fromDegrees(heading, pitch, roll)
                                    // Heading: rotation about the negative Z axis. Positive is clockwise.
                                    // OpenSky: 0 is North, clockwise. So 90 is East.
                                    // Cesium: 0 is North, clockwise. So 90 is East.
                                    // No conversion needed for heading directly.
                                    const hpr = new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(true_track), 0, 0);
                                    entity.orientation = Cesium.Transforms.headingPitchRollQuaternion(position, hpr);
                                }
                            } else {
                                // Create new entity
                                entity = viewer.entities.add({
                                    id: icao24,
                                    name: callsign,
                                    position: position,
                                    // Use a simple point or a model for aircraft
                                    billboard: {
                                        image: 'https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Assets/Textures/maki/airport.png', // A simple airport icon
                                        width: 24,
                                        height: 24,
                                        heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND, // Keep it above ground
                                        scaleByDistance: new Cesium.NearFarScalar(1.5e2, 1.5, 8.0e6, 0.2), // Scale based on distance
                                    },
                                    label: {
                                        text: callsign,
                                        font: '14px sans-serif',
                                        fillColor: Cesium.Color.WHITE,
                                        outlineColor: Cesium.Color.BLACK,
                                        outlineWidth: 2,
                                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                        pixelOffset: new Cesium.Cartesian2(0, -24), // Offset label above the billboard
                                        distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, 5000000), // Show label only when close
                                    },
                                    // Optional: Add a path to show recent movement
                                    path: {
                                        resolution: 1,
                                        material: new Cesium.PolylineOutlineMaterialProperty({
                                            color: Cesium.Color.RED.withAlpha(0.6),
                                            outlineColor: Cesium.Color.BLACK.withAlpha(0.6),
                                            outlineWidth: 2,
                                        }),
                                        width: 3,
                                        leadTime: 60, // Show path for the last 60 seconds
                                        trailTime: 60, // Show path for the next 60 seconds (not really applicable for real-time tracking this way, but good for future prediction)
                                    }
                                });
                                aircraftEntities.set(icao24, entity);
                            }
                            updatedAircraftIcaos.add(icao24);
                            currentAircraftCount++;
                        }
                    });

                    // Remove aircraft that are no longer in the data
                    const icao24sToRemove = [];
                    aircraftEntities.forEach((entity, icao24) => {
                        if (!updatedAircraftIcaos.has(icao24)) {
                            viewer.entities.remove(entity);
                            icao24sToRemove.push(icao24);
                        }
                    });
                    icao24sToRemove.forEach(icao24 => aircraftEntities.delete(icao24));

                    aircraftCountSpan.textContent = currentAircraftCount;
                    lastUpdatedSpan.textContent = new Date().toLocaleTimeString();
                    console.log(`Updated ${currentAircraftCount} aircraft.`);
                } else {
                    console.warn("OpenSky API response did not contain 'states' data.");
                }
            } catch (error) {
                console.error("Error fetching aircraft data:", error);
                // Display an error message to the user
                loadingOverlay.innerHTML = `Error fetching aircraft data: ${error.message}. Please check console for details.`;
            } finally {
                loadingOverlay.style.display = 'none'; // Hide loading overlay
            }
        }

        // Initialize the app
        window.onload = async function() {
            await loadCesiumIonAsset();
            await fetchAircraftData(); // Initial fetch
            // Update aircraft data every 15 seconds
            setInterval(fetchAircraftData, 15000);
        };

        // Add a listener for window resize to ensure Cesium viewer adapts
        window.addEventListener('resize', function() {
            viewer.resize();
        });

    </script>
</body>
</html>
