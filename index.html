<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CesiumJS 3D Asset Viewer with Flight Paths</title>
    <!-- Include CesiumJS CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        /* Ensure the Cesium viewer fills the entire screen */
        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: "Inter", sans-serif; /* Using Inter font */
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <!-- Include CesiumJS JavaScript -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>
    <script>
        // Ensure Cesium is loaded before proceeding
        if (typeof Cesium === 'undefined') {
            console.error("CesiumJS library not loaded. Please check the script URL.");
        } else {
            // Set your Cesium ion default access token
            Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmODM3ODY4YS0xMzE1LTRiMzktYjNhZi1lODdhNTgzY2RkZGYiLCJpZCI6MzIxMTg0LCJpYXQiOjE3NTI0NjQ0OTZ9.n2l0ALm9yy48XpkzjNxYgSw02XXw-PqQ9837LyaJ9Gc';

            // Initialize the Cesium Viewer
            const viewer = new Cesium.Viewer('cesiumContainer', {
                // Disable default imagery provider
                baseLayerPicker: false,
                imageryProvider: false,
                // Disable terrain provider
                terrainProvider: new Cesium.EllipsoidTerrainProvider(), // Use a flat ellipsoid terrain
                // Hide other default UI elements if desired
                geocoder: false,
                homeButton: false,
                infoBox: false,
                navigationHelpButton: false,
                sceneModePicker: false,
                timeline: false,
                animation: false,
                fullscreenButton: false,
                vrButton: false,
            });

            // Load the 3D asset from Cesium ion
            const assetId = 3548387; // Your Cesium ion 3D Asset ID

            // Add the 3D Tileset to the viewer
            const tileset = viewer.scene.primitives.add(
                new Cesium.Cesium3DTileset({
                    url: Cesium.IonResource.fromAssetId(assetId),
                })
            );

            // Once the tileset is loaded, zoom to its extent
            tileset.readyPromise.then(function(tileset) {
                viewer.zoomTo(tileset);

                // Optional: Adjust camera position after zooming if needed for a better view
                // For example, to look from a slightly higher angle:
                // viewer.camera.lookAtTransform(tileset.root.transform, new Cesium.HeadingPitchRange(0, -Cesium.Math.PI_OVER_FOUR, tileset.boundingSphere.radius * 1.5));

                console.log('3D Asset loaded and camera zoomed to its extent.');
            }).otherwise(function(error) {
                console.error(`Error loading 3D Tileset: ${error}`);
            });

            // Ensure the background is clear or a solid color if no imagery is desired
            viewer.scene.globe.show = false; // Hide the globe
            viewer.scene.backgroundColor = Cesium.Color.BLACK; // Set a black background

            // --- OpenSky Network Integration for Flight Paths ---

            // Global map to store aircraft entities and their sampled position properties
            // Key: ICAO 24-bit address (string)
            // Value: Object containing the Cesium.Entity and its Cesium.SampledPositionProperty
            const aircraftData = new Map();

            /**
             * Fetches aircraft data from the OpenSky Network API and visualizes it in CesiumJS.
             * Creates new entities for new aircraft or updates existing ones, and adds position samples
             * to their sampled position properties to draw flight paths.
             */
            async function fetchAndVisualizeAircraft() {
                try {
                    // Fetch data from the OpenSky Network API
                    const response = await fetch('https://opensky-network.org/api/states/all');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    // Get the current time in Cesium's JulianDate format
                    // This will be used as the timestamp for new position samples
                    const currentTime = Cesium.JulianDate.now();

                    // Set to keep track of ICAO24 addresses present in the current API response
                    const currentIcao24s = new Set();

                    if (data && data.states) {
                        // Iterate over each aircraft state received from the API
                        data.states.forEach(state => {
                            const icao24 = state[0]; // ICAO 24-bit address (unique identifier)
                            const callsign = state[1] ? state[1].trim() : 'N/A'; // Callsign (e.g., "UAL123")
                            const longitude = state[5]; // Longitude in degrees
                            const latitude = state[6];  // Latitude in degrees
                            const baroAltitude = state[7]; // Barometric altitude in meters
                            const onGround = state[8]; // Boolean: true if on ground, false if airborne
                            const lastPosUpdateUnix = state[4]; // Last time position was updated (Unix timestamp)

                            // Add the current aircraft's ICAO24 to our set for cleanup later
                            currentIcao24s.add(icao24);

                            // Only visualize airborne aircraft with valid coordinates and altitude
                            if (longitude !== null && latitude !== null && baroAltitude !== null && !onGround) {
                                // Convert longitude, latitude, and altitude to a Cesium.Cartesian3 position
                                const position = Cesium.Cartesian3.fromDegrees(longitude, latitude, baroAltitude);

                                // Convert the Unix timestamp of the last position update to Cesium.JulianDate
                                const sampleTime = Cesium.JulianDate.fromSecondsSinceEpoch(lastPosUpdateUnix);

                                // Check if an entry for this aircraft already exists in our map
                                let aircraftEntry = aircraftData.get(icao24);

                                if (!aircraftEntry) {
                                    // If it's a new aircraft, create a new SampledPositionProperty
                                    const sampledPosition = new Cesium.SampledPositionProperty();
                                    // Add the initial position sample
                                    sampledPosition.addSample(sampleTime, position);
                                    // Set interpolation options for smoother path visualization
                                    sampledPosition.setInterpolationOptions({
                                        interpolationDegree: 5,
                                        interpolationAlgorithm: Cesium.LagrangePolynomialApproximation
                                    });

                                    // Create a new Cesium.Entity for the aircraft
                                    const newEntity = viewer.entities.add({
                                        id: icao24, // Use ICAO24 as the entity ID
                                        position: sampledPosition, // Assign the sampled position property
                                        point: {
                                            pixelSize: 8,
                                            color: Cesium.Color.RED,
                                            outlineColor: Cesium.Color.WHITE,
                                            outlineWidth: 2,
                                        },
                                        label: {
                                            text: callsign, // Display the aircraft's callsign
                                            font: '14px sans-serif',
                                            fillColor: Cesium.Color.WHITE,
                                            outlineColor: Cesium.Color.BLACK,
                                            outlineWidth: 2,
                                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                            pixelOffset: new Cesium.Cartesian2(0, -15),
                                            showBackground: true, // Add background for better readability
                                            backgroundColor: Cesium.Color.BLACK.withAlpha(0.7),
                                            disableDepthTestDistance: Number.MAX_VALUE // Always show label
                                        },
                                        path: {
                                            resolution: 1,
                                            material: Cesium.Color.YELLOW.withAlpha(0.7),
                                            width: 2,
                                            leadTime: 0, // Do not show path ahead of current time
                                            trailTime: 300, // Show path for the last 5 minutes (300 seconds)
                                        }
                                    });
                                    // Store the new entity and its sampled position property in our map
                                    aircraftEntry = { entity: newEntity, sampledPosition: sampledPosition };
                                    aircraftData.set(icao24, aircraftEntry);

                                } else {
                                    // If the aircraft already exists, just add a new position sample
                                    aircraftEntry.sampledPosition.addSample(sampleTime, position);

                                    // Update the entity's label in case the callsign has changed
                                    aircraftEntry.entity.label.text = callsign;
                                }
                            } else {
                                // If aircraft is on ground or has invalid data, remove it from visualization if it exists
                                if (aircraftData.has(icao24)) {
                                    viewer.entities.remove(aircraftData.get(icao24).entity);
                                    aircraftData.delete(icao24);
                                }
                            }
                        });

                        // Clean up entities that are no longer present in the fetched data
                        // This handles aircraft that have landed, gone out of range, or stopped transmitting
                        for (const [icao24, entry] of aircraftData.entries()) {
                            if (!currentIcao24s.has(icao24)) {
                                viewer.entities.remove(entry.entity); // Remove the entity from the viewer
                                aircraftData.delete(icao24); // Remove from our map
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching OpenSky Network data:', error);
                    // In a production app, you might want to display a user-friendly error message
                }
            }

            // Set the viewer's clock to animate for sampled position properties to work correctly
            viewer.clock.shouldAnimate = true;
            viewer.clock.multiplier = 1; // Set playback speed (1 means real-time)

            // Call the function initially to load the first set of aircraft data
            fetchAndVisualizeAircraft();
            // Set an interval to periodically fetch and update aircraft data (every 15 seconds)
            setInterval(fetchAndVisualizeAircraft, 15000);
        }
    </script>
</body>
</html>
